# 使用包含CUDA和Miniconda的基础镜像
FROM nvidia/cuda:12.1.1-cudnn8-runtime-ubuntu22.04

# 设置环境变量
ENV CONDA_DIR=/opt/conda
ENV PATH /opt/conda/bin:$PATH
ENV LANG=C.UTF-8 LC_ALL=C.UTF-8

# 安装Opencv依赖
RUN apt-get update && apt-get install -y \
    libgl1-mesa-glx \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgl1 \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*

# 安装Miniconda
RUN apt-get update && apt-get install -y wget bzip2 && \
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh && \
    bash /tmp/miniconda.sh -b -p /opt/conda && \
    rm /tmp/miniconda.sh && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    $CONDA_DIR/bin/conda init bash

SHELL ["/bin/bash", "--login", "-c"]

RUN conda init && \
    conda config --set auto_activate_base false && \
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main && \
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r
# 创建工作目录
WORKDIR /app

RUN conda init && \
    conda create -n tfg_benchmark python=3.10 -y --quiet
# 复制项目文件
COPY . /app

# 设置Conda环境激活
ENV PATH /opt/conda/envs/tfg_benchmark/bin:$PATH
# 或者使用完整的conda初始化
RUN echo "conda activate tfg_benchmark" >> ~/.bashrc

# 安装项目依赖（如果有requirements.txt）
COPY requirements.txt . 
RUN pip install -r requirements.txt --no-cache-dir

# # 暴露端口（如果需要）
# EXPOSE 8000

# 设置启动命令
# CMD ["python", "app/main.py"]